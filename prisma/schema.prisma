generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String            @id @default(cuid())
  email             String            @unique
  passwordHash      String
  balanceCents      Int               @default(0)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  affiliate         Affiliate?
  invoices          PaymentInvoice[]
  tournamentEntries TournamentEntry[]
  tournamentRounds  TournamentRound[]
  transactions      Transaction[]
  withdrawals       WithdrawRequest[]
}

model Transaction {
  id          String   @id @default(cuid())
  userId      String
  type        TxType
  amountCents Int
  meta        Json?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model PaymentInvoice {
  id          String        @id @default(cuid())
  userId      String
  provider    String        @default("PassimPay")
  externalId  String?       @unique
  currency    String        @default("USDT")
  amountCents Int
  status      InvoiceStatus @default(PENDING)
  checkoutUrl String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model WithdrawRequest {
  id          String   @id @default(cuid())
  userId      String
  currency    String   @default("USDT")
  amountCents Int
  address     String
  status      String   @default("PENDING")
  externalId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model Affiliate {
  id          String             @id @default(cuid())
  userId      String             @unique
  code        String             @unique
  revshareBps Int                @default(2500)
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  user        User               @relation(fields: [userId], references: [id])
  clicks      AffiliateClick[]
  earnings    AffiliateEarning[]
  referrals   Referral[]
}

model AffiliateClick {
  id          String    @id @default(cuid())
  affiliateId String
  ipHash      String
  uaHash      String
  landingPath String?
  referrer    String?
  createdAt   DateTime  @default(now())
  affiliate   Affiliate @relation(fields: [affiliateId], references: [id])

  @@index([affiliateId, createdAt])
  @@index([ipHash, createdAt])
}

model Referral {
  id             String    @id @default(cuid())
  affiliateId    String
  referredUserId String    @unique
  firstClickId   String?
  createdAt      DateTime  @default(now())
  affiliate      Affiliate @relation(fields: [affiliateId], references: [id])
}

model AffiliateEarning {
  id             String    @id @default(cuid())
  affiliateId    String
  referredUserId String
  source         String
  invoiceId      String?
  amountCents    Int
  currency       String    @default("USD")
  meta           Json?
  createdAt      DateTime  @default(now())
  affiliate      Affiliate @relation(fields: [affiliateId], references: [id])

  @@unique([affiliateId, source, invoiceId])
  @@index([affiliateId, createdAt])
  @@index([referredUserId, createdAt])
}

model Tournament {
  id             String            @id @default(cuid())
  slug           String            @unique
  name           String
  type           TournamentType
  status         TournamentStatus  @default(ACTIVE)
  startsAt       DateTime          @db.Timestamp(3)
  endsAt         DateTime          @db.Timestamp(3)
  kFactor        Int               @default(10)
  prizePoolCents Int               @default(0)
  createdAt      DateTime          @default(now()) @db.Timestamp(3)
  entries        TournamentEntry[]
  rounds         TournamentRound[]

  @@index([status, endsAt])
}

model TournamentEntry {
  id             String     @id @default(cuid())
  tournamentId   String
  userId         String
  points         Float      @default(0)
  bestMultiplier Float      @default(1)
  roundsCount    Int        @default(0)
  lastRoundAt    DateTime?  @db.Timestamp(3)
  createdAt      DateTime   @default(now()) @db.Timestamp(3)
  updatedAt      DateTime   @updatedAt @db.Timestamp(3)
  tournament     Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, userId])
  @@index([tournamentId, points])
  @@index([userId, updatedAt])
}

model TournamentRound {
  id           String     @id @default(cuid())
  tournamentId String
  userId       String
  roundId      String
  stakeCents   Int
  multiplier   Float
  points       Float
  createdAt    DateTime   @default(now()) @db.Timestamp(3)
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, userId, roundId])
  @@unique([tournamentId, roundId])
  @@index([tournamentId, createdAt])
  @@index([userId, createdAt])
}

enum TxType {
  DEPOSIT
  BET
  WIN
  WITHDRAW
  ADJUST
}

enum InvoiceStatus {
  PENDING
  PAID
  EXPIRED
  FAILED
}

enum TournamentStatus {
  ACTIVE
  COMPLETED
}

enum TournamentType {
  DAILY_SPRINT
}
